name: Build Hackage packages

on:
  push:
  pull_request:

jobs:
  build-1-of-2:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        package: [ABList, AC-Angle, AC-Boolean, AC-Colour, AC-PPM, AC-Random, AES, AFSM, ALUT, ANum, AVar, AesonBson, Agda, Ansi2Html, AsyncRattus, BNFC, BNFC-meta, BerkeleyDB, BigPixel, Binpack, BiobaseNewick, Blammo, BluePrintCSS, Boolean, BoundedChan, CHXHtml, CSPM-CoreLanguage, CTRex, Cardinality, ChannelT, Chart, Chart-cairo, Chart-diagrams, Chart-gtk, Chart-gtk3, Chart-tests, ChasingBottoms, CheatSheet, CirruParser, Clipboard, Codec-Compression-LZF, Color, ConfigFile, ConsStream, Control-Engine, DAV, DBFunctor, DCFL, DPutils, Data-Angle, Data-Hash-Consistent, DataVersion, DebugTraceHelpers, Decimal, DescriptiveKeys, Diff, Digit, DigitGroup, DistanceTransform, DistanceUnits, Docs, EEConfig, ENIG, Earley, Ebnf2ps, EdisonAPI, EdisonCore, Enum, EuroIT, FAI, FailT, FenwickTree, FindBin, FixedPoint-simple, FloatingHex, Focus, Folly, FontyFruity, ForestStructures, FpMLv53, FractalArt, Frames, FunGEn, GA, GHood, GLFW-b, GLM, GLURaw, GLUT, GLUtil, GOST34112012-Hash, GaussQuadIntegration, GenericPretty, Geodetic, GeomPredicates, GiveYouAHead, Glob, GlomeVec, GoogleChart, GoogleSuggest, GraphSCC, HAppSHelpers, HCL, HCodecs, HDBC, HDBC-odbc, HDBC-postgresql, HDBC-session, HDBC-sqlite3, HGL, HListPP, HMap, HMock, HNumeric, HPDF, HSH, HSlippyMap, HSmarty, HStringTemplate, HSvm, HTF, HTTP, HTTP-Simple, HUnit, HUnit-approx, HaTeX, HaXml, HandsomeSoup, HasBigDecimal, HasChor, HaskellNet, HaskellNet-SSL, Hastodon, Hclip, Histogram, HoleyMonoid, Homology, HostAndPort, HsASA, HsHTSLib, HsOpenSSL, HsOpenSSL-x509-system, HsSyck, HsYAML, HsYAML-aeson, HyloDP, IOSpec, IPv6Addr, IfElse, Imlib, IndentParser, IntGraph, InternedData, Interpolation, Interpolation-maxs, IntervalMap, IrrHaskell, JSONParser, JuicyCairo, JuicyPixels, JuicyPixels-extra, JuicyPixels-repa, JuicyPixels-scale-dct, JuicyPixels-stbir, KMP, KdTree, Kleislify, LDAP, LPFP-core, LParse, LTree, LambdaCalculator, LambdaDB, Lazy-Pbkdf2, LetsBeRational, LinguisticsTypes, List, ListLike, ListTree, ListWriter, ListZipper, MemoTrie, MicroCabal, MicroHs, MissingH, MissingK, MissingM, Modulo, MonadPrompt, MonadRandom, Monadoro, MorseCode, MultipletCombiner, MusicBrainz, MusicBrainz-libdiscid, NameGenerator, NestedSampling, NineP, NoHoed, Noise, NumInstances, NumLazyByteString, Numbers, ObjectName, OneTuple, Only, OpenAL, OpenGL, OpenGLRaw, OptDir, OrderedBits, Ordinals, PDBtools, PSQueue, ParsecTools, ParserFunction, PartialTypeSignatures, PastePipe, Peano, PenroseKiteDart, PlayHangmanGame, Plural, PropLogic, ProxN, Pup-Events-Client, Pup-Events-PQueue, PyF, QuasiText, QuickCheck, QuickCheck-GenT, QuickCheck-safe, RANSAC, RBTree, RFC1751, RSA, RSolve, Random123, Ranged-sets, Rasterific, Rattus, ReadArgs, RefSerialize, RoyalMonad, SDL, SDL-gfx, SDL-image, SDL-ttf, SHA, SHA2, SQLDeps, STM32F103xx-SVD, STMonadTrans, SVGFonts, SVGPath, SWMMoutGetMB, Safe]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix-build nix/non-broken-haskell-packages.nix -A non-broken.${{ matrix.package }}

  build-2-of-2:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        package: [SafeSemaphore, SciBaseTypes, ShellCheck, ShowF, Shrub, Shu-thing, SimpleAES, SimpleEA, SimpleTableGenerator, Sit, SizeCompare, Spock-api, SpreadsheetML, Stack, StateVar, StateVar-transformer, StatisticalMethods, Stream, StringUtils, SvgIcons, TCache, TTTAS, TableAlgebra, Tensor, TernaryTrees, ThreadObjects, Tic-Tac-Toe, TraceUtils, Transhare, TreeT, Twofish, TypeNat, TypingTester, UISF, Unique, Unixutils, Useful, UtilityTM, Vec, Vec-Transform, VecN, ViennaRNA-bindings, ViennaRNAParser, Vulkan, WAVE, WidgetRattus, X11, X11-xft, X11-xshape, XAttr, XMLParser, Xauth, Yampa, Yampa-core, Yocto, ZipperAG, Zora, abc-puzzle, abstract-deque, abstract-deque-tests, abstract-par, acc, acid-state, acl2, acme-box, acme-cadre, acme-circular-containers, acme-cofunctor, acme-colosson, acme-cuteboy, acme-cutegirl, acme-default, acme-functors, acme-grawlix, acme-iot, acme-lolcat, acme-lookofdisapproval, acme-microwave, acme-missiles, acme-not-a-joke, acme-omitted, acme-one, acme-pointful-numbers, acme-realworld, acme-smuggler, acme-timemachine, acme-year, action-permutations, active, ad, ad-delcont, adaptive-cubature, adblock2privoxy, addLicenseInfo, adhoc-fixtures, adjunctions, adler32, advent-of-code-api, advent-of-code-ocr, aern2-fun, aern2-mfun, aern2-mp, aern2-real, aeson, aeson-attoparsec, aeson-better-errors, aeson-casing, aeson-coerce, aeson-combinators, aeson-diff, aeson-extra, aeson-generic-compat, aeson-helper, aeson-iproute, aeson-match-qq, aeson-optics, aeson-picker, aeson-pretty, aeson-qq, aeson-quick, aeson-result, aeson-schemas, aeson-serialize, aeson-tiled, aeson-typescript, aeson-unqualified-ast, aeson-value-parser, aeson-via, aeson-warning-parser, aeson-yak, aeson-yaml, affinely-extended, agda2lagda, agreeing, agum, air, air-spec, aivika, aivika-branches, aivika-experiment, aivika-experiment-cairo, aivika-experiment-chart, aivika-experiment-diagrams, aivika-lattice, aivika-realtime, aivika-transformers, alarmclock, alea, alex, alex-meta, alex-tools, algebra, algebraic-graphs, align, align-audio, aligned-foreignptr, alignment, alist, allocated-processor, almost-fix, alternative-vector, alternators, altsvc, always, amazonka, amazonka-accessanalyzer, amazonka-account, amazonka-alexa-business, amazonka-amp, amazonka-amplify, amazonka-amplifybackend, amazonka-amplifyuibuilder, amazonka-apigateway, amazonka-apigatewaymanagementapi, amazonka-apigatewayv2, amazonka-appconfig, amazonka-appconfigdata, amazonka-appflow, amazonka-appintegrations, amazonka-application-autoscaling, amazonka-application-insights, amazonka-applicationcostprofiler, amazonka-appmesh, amazonka-apprunner, amazonka-appstream, amazonka-appsync, amazonka-arc-zonal-shift, amazonka-athena, amazonka-auditmanager, amazonka-autoscaling, amazonka-autoscaling-plans, amazonka-backup, amazonka-backup-gateway, amazonka-backupstorage, amazonka-batch, amazonka-billingconductor, amazonka-braket, amazonka-budgets, amazonka-certificatemanager, amazonka-certificatemanager-pca, amazonka-chime, amazonka-chime-sdk-identity, amazonka-chime-sdk-media-pipelines, amazonka-chime-sdk-meetings, amazonka-chime-sdk-messaging, amazonka-chime-sdk-voice, amazonka-cloud9, amazonka-cloudcontrol, amazonka-clouddirectory, amazonka-cloudformation, amazonka-cloudfront, amazonka-cloudhsm, amazonka-cloudhsmv2, amazonka-cloudsearch, amazonka-cloudsearch-domains, amazonka-cloudtrail, amazonka-cloudwatch, amazonka-cloudwatch-events, amazonka-cloudwatch-logs, amazonka-codeartifact, amazonka-codebuild, amazonka-codecommit, amazonka-codedeploy, amazonka-codeguru-reviewer, amazonka-codeguruprofiler, amazonka-codepipeline, amazonka-codestar, amazonka-codestar-connections, amazonka-codestar-notifications, amazonka-cognito-identity, amazonka-cognito-idp, amazonka-cognito-sync, amazonka-comprehend, amazonka-comprehendmedical, amazonka-compute-optimizer, amazonka-config, amazonka-connect, amazonka-connect-contact-lens, amazonka-connectcampaigns, amazonka-connectcases, amazonka-connectparticipant, amazonka-controltower, amazonka-core, amazonka-cost-explorer, amazonka-cur, amazonka-customer-profiles, amazonka-databrew, amazonka-dataexchange, amazonka-datapipeline, amazonka-datasync, amazonka-detective, amazonka-devicefarm, amazonka-devops-guru, amazonka-directconnect, amazonka-discovery, amazonka-dlm]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix-build nix/non-broken-haskell-packages.nix -A non-broken.${{ matrix.package }}
